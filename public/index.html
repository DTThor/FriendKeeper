<!DOCTYPE html>
<html ng-app="app">
  <head>
    <meta charset="utf-8">
    <title>FriendKeeper</title>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  </head>
  <body>
    <app></app>
    <link href="https://fonts.googleapis.com/css?family=Alegreya+Sans" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.6/semantic.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.0/angular.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.js" integrity="sha256-laXWtGydpwqJ8JA+X9x2miwmaiKhn8tVmOVEigRNtP4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.6/semantic.min.js" charset="utf-8"></script>

    <script>
    angular.module('app', [])
    .component('app', {
      templateUrl: '/js/app/app.template.html',
      controller: appController
    })

      appController.$inject = ['$http']
      function appController($http){
        const vm = this
        let myInterval = null;

        const beginNotifying = () => {
          if(myInterval){
            clearInterval(myInterval);
            myInterval = null;
          }

          $http.get('/friends').then(function(res){

            vm.friends = res.data
            vm.friendsList = vm.friends.map(el=>{
              return el.name
            })
            let notifications = vm.friends.map(friend=>{
              return createNotifyObject(friend.name, friend.birthday, friend.email_interval, friend.phone_interval, friend.text_interval)
            })


            function createNotifyObject(name, birthday, email_interval, phone_interval, text_interval) {
             return   {
                 timestamp: Date.now() + (email_interval*1000),
                 note: function() {
                   return new Notification(name,{
                     requireInteraction: false,
                     body: `Hey, it's time to send ${name} an email!`,
                     title: name
                   })
                 },
                 notFired: true
               }
            }

            myInterval = setInterval(function(){
              notifications.forEach( el => {
                if ( Date.now() >= el.timestamp && el.notFired) {
                  console.log(  el.note() );
                  el.notFired = false;
                }
              })

            },100)

          })
          .catch( err => console.log(err))
        }

        vm.$onInit = function(){
          beginNotifying()
        }




        vm.addFriend = function addFriend(){
          var data = {
                name: vm.friend.name,
                phone_number: vm.friend.phone_number,
                email: vm.friend.email,
                birthday: vm.friend.birthday,
                anniversary: vm.friend.anniversary,
                date_added: Math.floor(Date.now()/100000),
                email_interval: vm.friend.email_interval,
                phone_interval: vm.friend.phone_interval,
                text_interval: vm.friend.text_interval
            };

          $http.post('/friends', data).then(function(data, status){
            vm.PostDataResponse = data.body;
          })
          vm.friendsList.push(vm.friend.name)
          beginNotifying();
          delete vm.friend
        }

        vm.editFriend = function(friend) {
          $http.patch('/friends/'+friend.id).then(function(data){
            console.log(data.body);
          })
        }

        vm.deleteFriend = function (e, friend) {
          e.preventDefault()
          $http.delete('/friends/'+ friend.id).then(function(data, status){
            vm.DeleteDataResponse = data.body;
          })
          vm.friends.splice(vm.friends.indexOf(friend), 1)
        }
      }
    </script>
  </body>
</html>
